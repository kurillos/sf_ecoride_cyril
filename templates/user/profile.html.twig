{% extends 'base.html.twig' %}

{% block title %}Mon Espace Utilisateur{% endblock %}

{% block body %}
    <div class="container my-5">
        <h1 class="text-center mb-4 text-ecoride">Mon Espace Utilisateur</h1>

        {% for message in app.flashes('success') %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
        {% for message in app.flashes('error') %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                {{ message}}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}

        <div class="row">
            {# Colonne de gauche (Photo de profil, infos, formulaire photo) #}
            <div class="col-md-3">
                <div class="card shadow-sm mb-4 text-center"> {# Ajout de text-center pour le centrage de l'image #}
                    {% if user.profilePictureFilename %}
                        <img src="{{ vich_uploader_asset(user, 'profilePictureFile') }}"
                             alt="photo de profil de {{ user.pseudo }}"
                             class="img-fluid rounded-circle mb-3 mx-auto d-block" {# Ajout de mx-auto d-block pour le centrage #}
                             style="width: 150px; height: 150px; object-fit: cover;">
                    {% else %}
                        {# image par défaut si pas de photo #}
                        <img src="{{ asset('images/default-profile-picture.jpg') }}"
                             alt="photo de profil par défaut"
                             class="img-fluid rounded-circle mb-3 mx-auto d-block" {# Ajout de mx-auto d-block pour le centrage #}
                             style="width: 150px; height: 150px; object-fit: cover;">
                    {% endif %}

                    <div class="card-body"> {# J'ai déplacé cette div ici pour mieux structurer le contenu de la carte #}
                        <h3>{{ user.pseudo }}</h3>
                        <p>{{ user.firstName }} {{ user.lastName }}</p>
                        <p>{{ user.email }}</p>
                        <p>Crédits : {{ user.credits }}</p>
                        <p>Rôles :
                            {% for role in user.roles %}
                                <span class="badge bg-secondary">{{ role|replace({'ROLE_': '', '_': ' '})|title }}</span>
                            {% endfor %}
                        </p>
                        {# Affichage des préférences directement depuis l'entité utilisateur pour la vue initiale #}
                        <p>Fumeur: {{ user.isSmoker ? 'Oui' : 'Non' }}</p>
                        <p>Accepte les animaux: {{ user.acceptsAnimals ? 'Oui' : 'Non' }}</p>
                        {% if user.additionalInfo %}
                            <p>Infos supplémentaires: {{ user.additionalInfo }}</p>
                        {% endif %}
                    </div>

                    {# Formulaire pour changer la photo de profil #}
                    <div class="card mt-4">
                        <div class="card-body text-center">
                            <h5 class="card-title">Changer ma photo de profil</h5>
                            {{ form_start(profilePictureForm) }}
                                {{ form_row(profilePictureForm.profilePictureFile) }}
                                <button type="submit" class="btn btn-primary mt-2">Changer la photo</button>
                            {{ form_end(profilePictureForm) }}
                        </div>
                    </div>
                </div> {# FIN DE card shadow-sm mb-4 #}
            </div> {# FIN DE col-md-3 #}

            {# Colonne de droite (Onglets : Informations personnelles, Préférences, Véhicules) #}
            <div class="col-md-9">
                <ul class="nav nav-tabs" id="profileTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active"
                                id="general-info-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#general-info"
                                type="button"
                                role="tab"
                                aria-controls="general-info"
                                aria-selected="true">
                            Mes informations personnelles
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link"
                                id="preferences-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#preferences"
                                type="button"
                                role="tab"
                                aria-controls="preferences"
                                aria-selected="false">
                            Mes préférences
                        </button>
                    </li>
                    {# Afficher les véhicules seulement si l'utilisateur est chauffeur #}
                    {% if user.isDriver() %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link"
                                id="vehicles-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#vehicles"
                                type="button"
                                role="tab"
                                aria-controls="vehicles"
                                aria-selected="false">
                            Mes véhicules
                        </button>
                    </li>
                    {% endif %}
                </ul>

                <div class="tab-content mt-3" id="profileTabsContent">
                    {# Onglet "Mes informations personnelles" (Initialement actif) #}
                    <div class="tab-pane fade show active"
                         id="general-info"
                         role="tabpanel"
                         aria-labelledby="general-info-tab">
                        <div class="card shadow-sm">
                            <div class="card-header">
                                Mes informations personnelles
                            </div>
                            <div class="card-body">
                            {% if profileForm is defined %}
                                {{ form_start(profileForm) }}
                                    {{ form_row(profileForm.email) }}
                                    {{ form_row(profileForm.firstName) }}
                                    {{ form_row(profileForm.lastName) }}
                                    {{ form_row(profileForm.pseudo) }}
                                    <button type="submit" class="btn btn-success mt-2">Mettre à jour</button>
                                {{ form_end(profileForm) }}
                            {% else %}
                                <p>Le formulaire de mise à jour des informations personnelles n'est pas disponible.</p>
                            {% endif %}
                            </div>
                        </div>
                    </div>

                    {# Préférences utilisateur #}
                    <div class="tab-pane fade"
                         id="preferences"
                         role="tabpanel"
                         aria-labelledby="preferences-tab">
                        <div class="card shadow-sm">
                            <div class="card-header">
                                Mes préférences
                            </div>
                            <div class="card-body">
                                {% if preferencesForm is defined %}
                                    {{ form_start(preferencesForm) }}
                                        {{ form_row(preferencesForm.isSmoker) }}
                                        {{ form_row(preferencesForm.acceptsAnimals) }}
                                        {{ form_row(preferencesForm.additionalInfo) }}

                                        <button type="submit" class="btn btn-success mt-3">Enregistrer les préférences</button>
                                    {{ form_end(preferencesForm) }}
                                {% else %}
                                    <p>Formulaire des préférences non disponible.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    {# Mes véhicules #}
                    {% if user.isDriver() %}
                    <div class="tab-pane fade"
                         id="vehicles"
                         role="tabpanel"
                         aria-labelledby="vehicles-tab">
                        <div class="card shadow-sm">
                            <div class="card-header">
                                Mes véhicules
                            </div>
                            <div class="card-body">
                                {# Afficher les véhicules ici #}
                                <p>Fonctionnalité d'ajout/modification de véhicules à venir.</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% block javascript %}
        {{ parent() }}
        <script src="{{ asset('assets/js/profile.js') }}"></script>
    {% endblock %}
{% endblock %}